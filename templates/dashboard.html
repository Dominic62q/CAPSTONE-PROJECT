{% load static %}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub - Find Your Squad</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
                        dark: { 800: '#1e1e2e', 900: '#11111b' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                        'zoom-in': 'zoomIn 0.8s ease-out forwards',
                        'pulse-glow': 'pulseGlow 2s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
                        zoomIn: { 
                            '0%': { opacity: '0', transform: 'scale(0.9) translateY(20px)', filter: 'blur(10px)' }, 
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)', filter: 'blur(0)' } 
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '0.5' },
                            '50%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(-45deg, #11111b, #0f172a, #1e1e2e, #312e81);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .hidden { display: none !important; }
        /* Loader CSS */
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="text-gray-100 font-sans min-h-screen flex flex-col">

    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-dark-900/95 backdrop-blur-sm hidden">
        <div class="w-full max-w-md p-8 glass rounded-2xl shadow-2xl animate-[fadeIn_0.5s_ease-out] transition-opacity duration-300" id="auth-card">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">StudyHub</h1>
                <p id="auth-title" class="text-gray-400 mt-2">Welcome back.</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <input type="text" id="login-username" placeholder="Username" required class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-brand-500 text-white outline-none">
                <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-brand-500 text-white outline-none">
                <div id="login-error" class="text-red-400 text-sm text-center hidden"></div>
                
                <button type="submit" id="login-btn" class="w-full py-3 px-4 bg-gradient-to-r from-brand-500 to-purple-600 hover:from-brand-600 hover:to-purple-700 text-white font-bold rounded-lg shadow-lg flex justify-center items-center gap-2 transition-all">
                    <span>Sign In</span>
                    <div id="login-loader" class="loader hidden"></div>
                </button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-username" placeholder="Username" required class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-lg text-white outline-none">
                <input type="email" id="reg-email" placeholder="Email" required class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-lg text-white outline-none">
                <div class="grid grid-cols-2 gap-2">
                    <input type="password" id="reg-password" placeholder="Password" required class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-lg text-white outline-none">
                    <input type="password" id="reg-password-2" placeholder="Confirm" required class="w-full px-4 py-3 bg-dark-800 border border-gray-700 rounded-lg text-white outline-none">
                </div>
                <div id="reg-error" class="text-red-400 text-sm text-center hidden"></div>
                
                <button type="submit" id="reg-btn" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg flex justify-center items-center gap-2 transition-all">
                    <span>Create Account</span>
                    <div id="reg-loader" class="loader hidden"></div>
                </button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-500">
                <span id="login-text">New here? <a href="#" id="show-register" class="text-brand-500 hover:underline">Register</a></span>
                <span id="register-text" class="hidden">Has account? <a href="#" id="show-login" class="text-brand-500 hover:underline">Sign In</a></span>
            </div>
        </div>
    </div>

    <div id="welcome-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-dark-900 hidden">
        <div class="absolute w-96 h-96 bg-brand-600/20 rounded-full blur-[100px] animate-pulse-glow"></div>
        <div class="relative z-10 text-center animate-zoom-in">
            <div class="mb-6 flex justify-center">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-brand-500 to-purple-600 flex items-center justify-center shadow-2xl">
                    <i data-lucide="graduation-cap" class="text-white w-10 h-10"></i>
                </div>
            </div>
            <h1 class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-blue-100 to-gray-400 tracking-tight mb-4">
                WELCOME TO<br>STUDYHUB
            </h1>
            <p class="text-brand-400 text-lg font-medium tracking-widest uppercase">Your Squad Awaits</p>
        </div>
    </div>

    <div id="app-container" class="hidden flex-col h-screen overflow-hidden">
        
        <header class="glass sticky top-0 z-40 border-b border-white/10 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    
                    <a href="/" class="flex items-center gap-3 group">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-500 to-purple-600 flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform">
                            <i data-lucide="graduation-cap" class="text-white w-6 h-6"></i>
                        </div>
                        <span class="text-2xl font-bold tracking-tight text-white group-hover:text-brand-400 transition-colors">StudyHub</span>
                    </a>

                    <div class="flex items-center gap-6">
                        <button 
                            class="hidden md:block text-sm font-medium text-gray-300 hover:text-white transition-colors"
                            hx-get="/api/groups/" 
                            hx-target="#main-content" 
                            hx-swap="innerHTML"
                        >
                            Discovery
                        </button>

                        <div class="h-6 w-px bg-white/10 hidden md:block"></div>

                        <div class="flex items-center gap-4">
                            <div class="text-right hidden sm:block">
                                <p class="text-xs text-gray-400">Signed in as</p>
                                <p id="nav-username" class="text-sm font-semibold text-white">Student</p>
                            </div>
                            
                            <div class="relative group">
                                <button class="relative w-11 h-11 rounded-full bg-brand-600 border-2 border-brand-400/50 flex items-center justify-center text-white font-bold text-lg shadow-lg hover:ring-4 hover:ring-brand-500/20 transition-all">
                                    <span id="user-avatar-text">U</span>
                                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-dark-900 rounded-full"></span>
                                </button>
                                
                                <div class="absolute right-0 mt-2 w-48 bg-dark-800 rounded-xl shadow-2xl border border-white/10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50 overflow-hidden">
                                    <div class="py-1">
                                        <a href="#" 
                                           hx-get="/api/profile/" 
                                           hx-target="#main-content" 
                                           hx-swap="innerHTML"
                                           class="flex items-center gap-2 px-4 py-3 text-sm text-gray-300 hover:bg-white/5 hover:text-white transition-colors"
                                        >
                                            <i data-lucide="user" class="w-4 h-4"></i> Profile
                                        </a>
                                        <div class="border-t border-white/10"></div>
                                        <button id="logout-btn" class="flex w-full items-center gap-2 px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 text-left transition-colors">
                                            <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </header>

        <main class="flex-grow relative overflow-y-auto">
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-600/20 rounded-full blur-3xl -z-10 animate-float pointer-events-none"></div>
            <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-blue-600/20 rounded-full blur-3xl -z-10 animate-float pointer-events-none" style="animation-delay: -3s;"></div>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div id="main-content" class="min-h-[60vh] animate-fade-in">
                    <div class="flex flex-col items-center justify-center text-center py-16">
                        <h1 class="text-5xl md:text-7xl font-extrabold text-white tracking-tight mb-6">
                            Master Your Subjects.<br>
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-500 to-purple-500">
                                Find Your Squad.
                            </span>
                        </h1>
                        <p class="text-xl text-gray-400 max-w-2xl mb-10 leading-relaxed">
                            Connect with students who share your classes. Share resources, chat in real-time, and ace your exams together.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button 
                                class="px-8 py-4 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-brand-500/25 transition-all transform hover:-translate-y-1"
                                hx-get="/api/groups/" 
                                hx-target="#main-content" 
                                hx-swap="innerHTML"
                            >
                                Explore Groups ðŸš€
                            </button>
                            <button 
                                class="px-8 py-4 glass text-white rounded-xl font-semibold text-lg hover:bg-white/10 transition-all"
                                hx-get="/api/matches/" 
                                hx-target="#main-content" 
                                hx-swap="innerHTML"
                            >
                                Find a Buddy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();
        const authOverlay = document.getElementById('auth-overlay');
        const welcomeOverlay = document.getElementById('welcome-overlay'); 
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');
        const authCard = document.getElementById('auth-card');

        // Toggles
        document.getElementById('show-register').onclick = (e) => { e.preventDefault(); loginForm.classList.add('hidden'); regForm.classList.remove('hidden'); document.getElementById('login-text').classList.add('hidden'); document.getElementById('register-text').classList.remove('hidden'); document.getElementById('auth-title').innerText = "Join the Squad"; };
        document.getElementById('show-login').onclick = (e) => { e.preventDefault(); regForm.classList.add('hidden'); loginForm.classList.remove('hidden'); document.getElementById('register-text').classList.add('hidden'); document.getElementById('login-text').classList.remove('hidden'); document.getElementById('auth-title').innerText = "Welcome back"; };

        // Welcome Animation
        function playWelcomeSequence() {
            authOverlay.classList.add('hidden');
            welcomeOverlay.classList.remove('hidden');
            
            // Fast transition: 1.2s total wait
            setTimeout(() => {
                welcomeOverlay.classList.add('hidden');
                checkAuth(); 
            }, 1200);
        }

        // Auth Logic
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            if (token && username) {
                authOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                document.getElementById('nav-username').textContent = username;
                document.getElementById('user-avatar-text').textContent = username.charAt(0).toUpperCase();
            } else {
                authOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }
        }
        checkAuth();

        // Helper to toggle loading state
        function setLoading(btnId, loaderId, isLoading) {
            const btn = document.getElementById(btnId);
            const loader = document.getElementById(loaderId);
            const span = btn.querySelector('span');
            
            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                loader.classList.remove('hidden');
                span.textContent = 'Verifying...';
                authCard.classList.add('opacity-50'); // Dim the card
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                loader.classList.add('hidden');
                span.textContent = btnId === 'login-btn' ? 'Sign In' : 'Create Account';
                authCard.classList.remove('opacity-50');
            }
        }

        // Login Handler
        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            
            // 1. Show Loading IMMEDIATELY
            setLoading('login-btn', 'login-loader', true);
            
            try {
                const res = await fetch('/api/login/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                const data = await res.json();
                
                if(res.ok) { 
                    localStorage.setItem('authToken', data.token); 
                    localStorage.setItem('username', data.username); 
                    playWelcomeSequence(); 
                } else {
                    throw new Error(data.error);
                }
            } catch(err) { 
                // Reset loading if error
                setLoading('login-btn', 'login-loader', false);
                document.getElementById('login-error').innerText = err.message; 
                document.getElementById('login-error').classList.remove('hidden'); 
            }
        };

        // Register Handler
        regForm.onsubmit = async (e) => {
            e.preventDefault();
             const u = document.getElementById('reg-username').value;
             const em = document.getElementById('reg-email').value;
             const p = document.getElementById('reg-password').value;
             const p2 = document.getElementById('reg-password-2').value;
             
             if(p!==p2) {
                document.getElementById('reg-error').innerText = "Passwords do not match";
                document.getElementById('reg-error').classList.remove('hidden');
                return;
             }

             setLoading('reg-btn', 'reg-loader', true);
             
             try {
                const res = await fetch('/api/register/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, email: em, password: p, password2: p2}) });
                if(res.ok) {
                    const loginRes = await fetch('/api/login/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                    const data = await loginRes.json();
                    localStorage.setItem('authToken', data.token); 
                    localStorage.setItem('username', data.username); 
                    playWelcomeSequence(); 
                } else {
                    const data = await res.json();
                    let msg = "Registration failed";
                    if(data.username) msg = data.username[0];
                    setLoading('reg-btn', 'reg-loader', false);
                    throw new Error(msg);
                }
             } catch(err) {
                setLoading('reg-btn', 'reg-loader', false);
                document.getElementById('reg-error').innerText = err.message; 
                document.getElementById('reg-error').classList.remove('hidden');
             }
        };

        document.getElementById('logout-btn').onclick = async () => {
            const token = localStorage.getItem('authToken');
            if(token) await fetch('/api/logout/', { method: 'POST', headers: {'Authorization': `Token ${token}`} });
            localStorage.clear(); window.location.reload();
        };

        document.body.addEventListener('htmx:configRequest', (evt) => {
            const token = localStorage.getItem('authToken');
            if(token) evt.detail.headers['Authorization'] = `Token ${token}`;
        });
        
        document.body.addEventListener('htmx:afterSwap', (evt) => {
            lucide.createIcons();
        });
    </script>
</body>
</html>